{% extends "base.html" %}

{% block title %}Gerenciamento de Usuários - Sistema de Gestão{% endblock %}
{% block page_title %}Gerenciamento de Usuários{% endblock %}

{% block top_actions %}
<button class="btn btn-primary" onclick="abrirModalNovoUsuario()">
    <i class="fas fa-user-plus"></i>
    Novo Usuário
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-users"></i>
            Usuários do Sistema
        </h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Função</th>
                    <th>Status</th>
                    <th>Criado em</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="usuariosTable">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px;">
                        <span class="loading-spinner"></span> Carregando...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal" id="modalUsuario">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Novo Usuário</h3>
            <button class="modal-close" onclick="fecharModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formUsuario">
                <input type="hidden" id="usuarioId">
                <div class="form-group">
                    <label class="form-label">Nome completo</label>
                    <input type="text" class="form-control" id="nome" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="form-group" id="senhaGroup">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="senha" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Função</label>
                    <select class="form-select" id="funcao" required>
                        <option value="Admin">Admin</option>
                        <option value="Gestor">Gestor</option>
                        <option value="Consultor">Consultor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="ativo">
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="salvarUsuario()">
                <i class="fas fa-save"></i>
                Salvar
            </button>
        </div>
    </div>
</div>

<div class="modal" id="modalConfirm">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Confirmar Exclusão</h3>
            <button class="modal-close" onclick="fecharModalConfirm()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja deletar este usuário?</p>
            <p><strong id="nomeDelete"></strong></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="fecharModalConfirm()">Cancelar</button>
            <button class="btn btn-danger" onclick="confirmarDelete()">
                <i class="fas fa-trash"></i>
                Deletar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let usuarioParaDeletar = null;

async function carregarUsuarios() {
    try {
        const response = await fetchAPI('/api/usuarios');
        const usuarios = await response.json();
        
        const tbody = document.getElementById('usuariosTable');
        if (usuarios.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-users"></i></div>
                        <div class="empty-state-title">Nenhum usuário encontrado</div>
                        <div class="empty-state-description">Comece adicionando um novo usuário ao sistema</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = usuarios.map(usuario => `
            <tr>
                <td>${usuario.nome}</td>
                <td>${usuario.email}</td>
                <td><span class="badge badge-primary">${usuario.funcao}</span></td>
                <td>
                    <span class="badge ${usuario.ativo ? 'badge-success' : 'badge-danger'}">
                        ${usuario.ativo ? 'Ativo' : 'Inativo'}
                    </span>
                </td>
                <td>${new Date(usuario.criado_em).toLocaleDateString('pt-BR')}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="editarUsuario(${usuario.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deletarUsuario(${usuario.id}, '${usuario.nome}')" title="Deletar">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
    }
}

function abrirModalNovoUsuario() {
    document.getElementById('modalTitle').textContent = 'Novo Usuário';
    document.getElementById('formUsuario').reset();
    document.getElementById('usuarioId').value = '';
    document.getElementById('senhaGroup').style.display = 'block';
    document.getElementById('senha').required = true;
    document.getElementById('modalUsuario').classList.add('active');
}

async function editarUsuario(id) {
    try {
        const response = await fetchAPI('/api/usuarios');
        const usuarios = await response.json();
        const usuario = usuarios.find(u => u.id === id);
        
        if (usuario) {
            document.getElementById('modalTitle').textContent = 'Editar Usuário';
            document.getElementById('usuarioId').value = usuario.id;
            document.getElementById('nome').value = usuario.nome;
            document.getElementById('email').value = usuario.email;
            document.getElementById('funcao').value = usuario.funcao;
            document.getElementById('ativo').value = usuario.ativo.toString();
            document.getElementById('senhaGroup').style.display = 'none';
            document.getElementById('senha').required = false;
            document.getElementById('modalUsuario').classList.add('active');
        }
    } catch (error) {
        console.error('Erro ao carregar usuário:', error);
    }
}

async function salvarUsuario() {
    const id = document.getElementById('usuarioId').value;
    const nome = document.getElementById('nome').value;
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;
    const funcao = document.getElementById('funcao').value;
    const ativo = document.getElementById('ativo').value === 'true';
    
    try {
        if (id) {
            await fetchAPI(`/api/usuarios/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, email, funcao, ativo })
            });
        } else {
            await fetchAPI('/api/usuarios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, email, senha, funcao })
            });
        }
        
        fecharModal();
        carregarUsuarios();
    } catch (error) {
        console.error('Erro ao salvar usuário:', error);
        alert('Erro ao salvar usuário');
    }
}

function deletarUsuario(id, nome) {
    usuarioParaDeletar = id;
    document.getElementById('nomeDelete').textContent = nome;
    document.getElementById('modalConfirm').classList.add('active');
}

async function confirmarDelete() {
    if (!usuarioParaDeletar) return;
    
    try {
        await fetchAPI(`/api/usuarios/${usuarioParaDeletar}`, {
            method: 'DELETE'
        });
        
        fecharModalConfirm();
        carregarUsuarios();
        usuarioParaDeletar = null;
    } catch (error) {
        console.error('Erro ao deletar usuário:', error);
        alert('Erro ao deletar usuário');
    }
}

function fecharModal() {
    document.getElementById('modalUsuario').classList.remove('active');
}

function fecharModalConfirm() {
    document.getElementById('modalConfirm').classList.remove('active');
    usuarioParaDeletar = null;
}

carregarUsuarios();
</script>
{% endblock %}
