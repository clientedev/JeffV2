{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Gestão Operacional{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Propostas Ativas</div>
        <div class="stat-value" id="propostas_ativas">0</div>
        <div class="stat-change positive" id="propostas_change">
            <i class="fas fa-arrow-up"></i> 12% vs mês anterior
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Fechadas no Mês</div>
        <div class="stat-value" id="propostas_fechadas_mes">0</div>
        <div class="stat-change positive" id="fechadas_change">
            <i class="fas fa-arrow-up"></i> 8% vs mês anterior
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Taxa de Conversão</div>
        <div class="stat-value" id="taxa_conversao">0%</div>
        <div class="stat-change negative" id="conversao_change">
            <i class="fas fa-arrow-down"></i> -3% vs mês anterior
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Receita Mensal</div>
        <div class="stat-value" id="receita_mes">R$ 0</div>
        <div class="stat-change positive" id="receita_change">
            <i class="fas fa-arrow-up"></i> 15% vs mês anterior
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-bottom: 24px;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Propostas por Status</h3>
        </div>
        <div id="graficoPropostaStatus"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Receita Mensal</h3>
        </div>
        <div id="graficoReceitaMensal"></div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px; margin-bottom: 24px;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Propostas por Consultor</h3>
        </div>
        <div id="graficoConsultor"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Produtividade (Horas)</h3>
        </div>
        <div id="graficoProdutividade"></div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-robot"></i>
            Assistente Inteligente
        </h3>
    </div>
    <div style="padding: 24px;">
        <div class="form-group">
            <input type="text" class="form-control" id="chatInput" placeholder="Ex: Quais contratos vencem esta semana?">
        </div>
        <button class="btn btn-primary" onclick="enviarPergunta()">
            <i class="fas fa-paper-plane"></i>
            Perguntar
        </button>
        <div id="chatResponse" style="margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color); min-height: 60px; display: none;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/dashboard.js"></script>
<script>
function enviarPergunta() {
    const input = document.getElementById('chatInput');
    const responseDiv = document.getElementById('chatResponse');
    const pergunta = input.value.trim();
    
    if (!pergunta) return;
    
    responseDiv.style.display = 'block';
    responseDiv.innerHTML = '<div style="display: flex; align-items: center; gap: 12px;"><span class="loading-spinner"></span><span>Processando...</span></div>';
    
    fetchAPI('/api/chatbot/perguntar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pergunta })
    })
    .then(res => res.json())
    .then(data => {
        responseDiv.innerHTML = `<div style="color: var(--text-primary);"><strong>Resposta:</strong><br>${data.resposta}</div>`;
    })
    .catch(err => {
        responseDiv.innerHTML = '<div style="color: var(--accent-danger);">Erro ao processar pergunta. Tente novamente.</div>';
    });
}

document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') enviarPergunta();
});
</script>
{% endblock %}
