{% extends "base.html" %}

{% block title %}Cronograma Visual - Sistema de Gestão{% endblock %}
{% block page_title %}Cronograma de Alocações{% endblock %}

{% block top_actions %}
<button class="btn btn-primary" onclick="abrirModalNovaAlocacao()">
    <i class="fas fa-plus"></i>
    Nova Alocação
</button>
<button class="btn btn-success" onclick="exportarPDF()">
    <i class="fas fa-file-pdf"></i>
    Exportar PDF
</button>
<button class="btn btn-success" onclick="exportarExcel()">
    <i class="fas fa-file-excel"></i>
    Exportar Excel
</button>
{% endblock %}

{% block content %}
<style>
:root {
    --bg-dark: #1a1d2e;
    --bg-darker: #12141f;
    --bg-card: #22273b;
    --text-light: #e0e0e0;
    --border-color: #2d3548;
    --hover-bg: #2a3047;
}

.filters-card {
    background: var(--bg-card);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
}

.filter-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--text-light);
}

.filter-group input,
.filter-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
    background: var(--bg-darker);
    color: var(--text-light);
}

.legend-card {
    background: var(--bg-card);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
}

.legend-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 15px;
    color: var(--text-light);
}

.legend-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--bg-darker);
    border-radius: 4px;
}

.legend-color {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
}

.legend-name {
    color: var(--text-light);
    font-size: 14px;
}

/* Cores da legenda */
.color-C { background-color: #5B9BD5; color: white; }
.color-K { background-color: #70AD47; color: white; }
.color-F { background-color: #0070C0; color: white; }
.color-M { background-color: #C00000; color: white; }
.color-T { background-color: #FFC000; color: black; }
.color-P { background-color: #FF6600; color: white; }
.color-O { background-color: #000000; color: white; }

.calendar-container {
    background: var(--bg-card);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.calendar-nav {
    display: flex;
    gap: 10px;
    align-items: center;
}

.calendar-nav button {
    background: var(--bg-darker);
    color: var(--text-light);
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.calendar-nav button:hover {
    background: var(--hover-bg);
}

.calendar-month {
    font-size: 24px;
    font-weight: bold;
    color: var(--text-light);
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 2px;
}

.calendar-weekday {
    padding: 10px;
    text-align: center;
    background: var(--bg-darker);
    color: #888;
    font-weight: bold;
    font-size: 12px;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.calendar-day {
    min-height: 120px;
    background: var(--bg-darker);
    padding: 8px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.calendar-day:hover {
    background: var(--hover-bg);
    border-color: #4a5568;
}

.calendar-day.other-month {
    opacity: 0.3;
}

.day-number {
    font-size: 14px;
    font-weight: bold;
    color: var(--text-light);
    margin-bottom: 5px;
}

.day-alocacoes {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.alocacao-item {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 6px;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
    position: relative;
}

.alocacao-item:hover {
    opacity: 0.8;
}

.alocacao-item .delete-btn {
    display: none;
    position: absolute;
    right: 2px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 0, 0, 0.8);
    color: white;
    border: none;
    border-radius: 3px;
    padding: 2px 4px;
    cursor: pointer;
    font-size: 10px;
}

.alocacao-item:hover .delete-btn {
    display: block;
}

.alocacao-consultor {
    font-weight: 500;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.alocacao-periodo {
    font-size: 9px;
    opacity: 0.8;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow: auto;
}

.modal-content {
    background-color: var(--bg-card);
    margin: 3% auto;
    padding: 30px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    border: 1px solid var(--border-color);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h2 {
    margin: 0;
    color: var(--text-light);
}

.close {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
}

.close:hover {
    color: var(--text-light);
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--text-light);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-darker);
    color: var(--text-light);
}

.day-detail-alocacoes {
    margin-top: 20px;
}

.day-detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    background: var(--bg-darker);
    border-radius: 4px;
    border-left: 4px solid;
}

.day-detail-info {
    flex: 1;
}

.day-detail-actions {
    display: flex;
    gap: 8px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: var(--bg-card);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #888;
}

.stat-card .value {
    font-size: 32px;
    font-weight: bold;
    color: var(--text-light);
}
</style>

<div class="filters-card">
    <h3 style="margin-top: 0; color: var(--text-light);">Filtros</h3>
    <div class="filter-row">
        <div class="filter-group">
            <label>Mês/Ano</label>
            <input type="month" id="mesAno" onchange="aplicarFiltros()">
        </div>
        <div class="filter-group">
            <label>Consultor</label>
            <select id="consultorFiltro" onchange="aplicarFiltros()">
                <option value="">Todos</option>
            </select>
        </div>
    </div>
</div>

<div class="legend-card">
    <div class="legend-title">SIGLAS / LEGENDA</div>
    <div class="legend-grid">
        <div class="legend-item">
            <div class="legend-color color-C">C-</div>
            <div class="legend-name">CONSULTORIA</div>
        </div>
        <div class="legend-item">
            <div class="legend-color color-K">K-</div>
            <div class="legend-name">KICK-OFF</div>
        </div>
        <div class="legend-item">
            <div class="legend-color color-F">F-</div>
            <div class="legend-name">REUNIÃO FINAL</div>
        </div>
        <div class="legend-item">
            <div class="legend-color color-M">M-</div>
            <div class="legend-name">MENTORIA</div>
        </div>
        <div class="legend-item">
            <div class="legend-color color-T">T-</div>
            <div class="legend-name">T0 - DIAGNÓSTICO</div>
        </div>
        <div class="legend-item">
            <div class="legend-color color-P">P-</div>
            <div class="legend-name">PROGRAMADO</div>
        </div>
        <div class="legend-item">
            <div class="legend-color color-O">O-</div>
            <div class="legend-name">OUTROS</div>
        </div>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3>Total de Alocações</h3>
        <div class="value" id="totalAlocacoes">0</div>
    </div>
    <div class="stat-card">
        <h3>Consultores Ativos</h3>
        <div class="value" id="totalConsultores">0</div>
    </div>
    <div class="stat-card">
        <h3>Dias com Alocação</h3>
        <div class="value" id="diasAlocados">0</div>
    </div>
</div>

<div class="calendar-container">
    <div class="calendar-header">
        <div class="calendar-nav">
            <button onclick="mesAnterior()"><i class="fas fa-chevron-left"></i></button>
            <span class="calendar-month" id="mesAtual">Janeiro 2024</span>
            <button onclick="proximoMes()"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>
    
    <div class="calendar-weekdays">
        <div class="calendar-weekday">DOM</div>
        <div class="calendar-weekday">SEG</div>
        <div class="calendar-weekday">TER</div>
        <div class="calendar-weekday">QUA</div>
        <div class="calendar-weekday">QUI</div>
        <div class="calendar-weekday">SEX</div>
        <div class="calendar-weekday">SÁB</div>
    </div>
    
    <div class="calendar-days" id="calendarDays"></div>
</div>

<div id="modalNovaAlocacao" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Nova Alocação</h2>
            <span class="close" onclick="fecharModal()">&times;</span>
        </div>
        <form id="formNovaAlocacao" onsubmit="salvarNovaAlocacao(event)">
            <div class="form-group">
                <label>Consultor *</label>
                <select id="consultorNovo" required>
                    <option value="">Selecione...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Data *</label>
                <input type="date" id="dataNova" required>
            </div>
            <div class="form-group">
                <label>Período *</label>
                <select id="periodoNovo" required>
                    <option value="">Selecione...</option>
                    <option value="M">Manhã (M)</option>
                    <option value="T">Tarde (T)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Código do Projeto *</label>
                <input type="text" id="projetoNovo" placeholder="Ex: C-PRODMEC" required>
            </div>
            <div class="form-group">
                <label>Observação</label>
                <input type="text" id="observacaoNova">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalEditarDia" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="tituloEditarDia">Editar Dia</h2>
            <span class="close" onclick="fecharModalEditarDia()">&times;</span>
        </div>
        <div id="conteudoEditarDia"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let alocacoesData = [];
let consultoresData = [];
let mesAtual = new Date();
let dataAtual = '';

function getCorProjeto(codigo) {
    if (!codigo) return 'color-O';
    const prefixo = codigo.split('-')[0];
    const cores = {
        'C': 'color-C',
        'K': 'color-K',
        'F': 'color-F',
        'M': 'color-M',
        'T': 'color-T',
        'P': 'color-P',
        'O': 'color-O'
    };
    return cores[prefixo] || 'color-O';
}

async function carregarConsultores() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/consultores/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        consultoresData = data;
        
        const selectFiltro = document.getElementById('consultorFiltro');
        const selectNovo = document.getElementById('consultorNovo');
        
        data.forEach(consultor => {
            const option1 = new Option(consultor.nome, consultor.id);
            const option2 = new Option(consultor.nome, consultor.id);
            selectFiltro.add(option1);
            selectNovo.add(option2);
        });
    } catch (error) {
        console.error('Erro ao carregar consultores:', error);
    }
}

async function carregarAlocacoes() {
    try {
        const token = localStorage.getItem('token');
        const ano = mesAtual.getFullYear();
        const mes = String(mesAtual.getMonth() + 1).padStart(2, '0');
        const dataInicio = `${ano}-${mes}-01`;
        const ultimoDia = new Date(ano, mesAtual.getMonth() + 1, 0).getDate();
        const dataFim = `${ano}-${mes}-${ultimoDia}`;
        const consultorId = document.getElementById('consultorFiltro').value;
        
        let url = `/api/cronogramas/alocacoes/listar?data_inicio=${dataInicio}&data_fim=${dataFim}`;
        if (consultorId) url += `&consultor_id=${consultorId}`;
        
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const alocacoes = await response.json();
        alocacoesData = alocacoes;
        
        renderizarCalendario();
        atualizarEstatisticas();
    } catch (error) {
        console.error('Erro ao carregar alocações:', error);
    }
}

function atualizarEstatisticas() {
    document.getElementById('totalAlocacoes').textContent = alocacoesData.length;
    
    const consultoresUnicos = new Set(alocacoesData.map(a => a.consultor_id));
    document.getElementById('totalConsultores').textContent = consultoresUnicos.size;
    
    const diasUnicos = new Set(alocacoesData.map(a => a.data));
    document.getElementById('diasAlocados').textContent = diasUnicos.size;
}

function renderizarCalendario() {
    const ano = mesAtual.getFullYear();
    const mes = mesAtual.getMonth();
    
    document.getElementById('mesAtual').textContent = 
        mesAtual.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
    
    const primeiroDia = new Date(ano, mes, 1);
    const ultimoDia = new Date(ano, mes + 1, 0);
    const diasNoMes = ultimoDia.getDate();
    const diaSemanaInicio = primeiroDia.getDay();
    
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';
    
    // Dias do mês anterior
    const diasMesAnterior = new Date(ano, mes, 0).getDate();
    for (let i = diaSemanaInicio - 1; i >= 0; i--) {
        const dia = diasMesAnterior - i;
        const cell = criarCelulaDia(dia, true);
        calendarDays.appendChild(cell);
    }
    
    // Dias do mês atual
    for (let dia = 1; dia <= diasNoMes; dia++) {
        const data = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const alocacoesDia = alocacoesData.filter(a => a.data === data);
        const cell = criarCelulaDia(dia, false, data, alocacoesDia);
        calendarDays.appendChild(cell);
    }
    
    // Dias do próximo mês
    const totalCelulas = calendarDays.children.length;
    const celulasRestantes = 35 - totalCelulas;
    for (let dia = 1; dia <= celulasRestantes; dia++) {
        const cell = criarCelulaDia(dia, true);
        calendarDays.appendChild(cell);
    }
}

function criarCelulaDia(dia, outroMes, data = null, alocacoes = []) {
    const cell = document.createElement('div');
    cell.className = `calendar-day ${outroMes ? 'other-month' : ''}`;
    
    if (!outroMes && data) {
        cell.onclick = () => abrirModalEditarDia(data);
    }
    
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = dia;
    cell.appendChild(dayNumber);
    
    if (alocacoes.length > 0) {
        const dayAlocacoes = document.createElement('div');
        dayAlocacoes.className = 'day-alocacoes';
        
        alocacoes.forEach(alocacao => {
            const item = document.createElement('div');
            item.className = `alocacao-item ${getCorProjeto(alocacao.codigo_projeto)}`;
            item.innerHTML = `
                <span class="alocacao-consultor" title="${alocacao.consultor_nome}">${alocacao.consultor_nome}</span>
                <span class="alocacao-periodo">${alocacao.periodo}</span>
                <button class="delete-btn" onclick="event.stopPropagation(); deletarAlocacao(${alocacao.id})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            dayAlocacoes.appendChild(item);
        });
        
        cell.appendChild(dayAlocacoes);
    }
    
    return cell;
}

function mesAnterior() {
    mesAtual = new Date(mesAtual.getFullYear(), mesAtual.getMonth() - 1, 1);
    carregarAlocacoes();
}

function proximoMes() {
    mesAtual = new Date(mesAtual.getFullYear(), mesAtual.getMonth() + 1, 1);
    carregarAlocacoes();
}

function aplicarFiltros() {
    const mesAnoInput = document.getElementById('mesAno').value;
    if (mesAnoInput) {
        const [ano, mes] = mesAnoInput.split('-');
        mesAtual = new Date(parseInt(ano), parseInt(mes) - 1, 1);
    }
    carregarAlocacoes();
}

function abrirModalNovaAlocacao() {
    document.getElementById('modalNovaAlocacao').style.display = 'block';
}

function fecharModal() {
    document.getElementById('modalNovaAlocacao').style.display = 'none';
    document.getElementById('formNovaAlocacao').reset();
}

async function salvarNovaAlocacao(event) {
    event.preventDefault();
    
    const token = localStorage.getItem('token');
    const data = {
        consultor_id: parseInt(document.getElementById('consultorNovo').value),
        data: document.getElementById('dataNova').value,
        periodo: document.getElementById('periodoNovo').value,
        codigo_projeto: document.getElementById('projetoNovo').value,
        observacao: document.getElementById('observacaoNova').value || null
    };
    
    try {
        const response = await fetch('/api/cronogramas/alocacoes/criar', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Alocação criada com sucesso!');
            fecharModal();
            carregarAlocacoes();
        } else {
            const error = await response.json();
            alert('Erro ao criar alocação: ' + (error.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao criar alocação. Tente novamente.');
    }
}

function abrirModalEditarDia(data) {
    dataAtual = data;
    const alocacoes = alocacoesData.filter(a => a.data === data);
    
    const dataFormatada = new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
    document.getElementById('tituloEditarDia').textContent = `Editar ${dataFormatada}`;
    
    let html = `
        <div class="day-detail-alocacoes">
            ${alocacoes.length > 0 ? 
                alocacoes.map(a => `
                    <div class="day-detail-item" style="border-color: ${getCorBorda(a.codigo_projeto)}">
                        <div class="day-detail-info">
                            <strong>${a.consultor_nome}</strong> - ${a.periodo === 'M' ? 'Manhã' : 'Tarde'}<br>
                            <small>${a.codigo_projeto || 'Sem projeto'}</small>
                        </div>
                        <div class="day-detail-actions">
                            <button class="btn btn-sm btn-danger" onclick="deletarAlocacao(${a.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') 
                : '<p style="color: #888;">Nenhuma alocação neste dia</p>'
            }
        </div>
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="adicionarAlocacaoNoDia('${data}')">
                <i class="fas fa-plus"></i> Adicionar Alocação
            </button>
        </div>
    `;
    
    document.getElementById('conteudoEditarDia').innerHTML = html;
    document.getElementById('modalEditarDia').style.display = 'block';
}

function getCorBorda(codigo) {
    if (!codigo) return '#888';
    const prefixo = codigo.split('-')[0];
    const cores = {
        'C': '#5B9BD5',
        'K': '#70AD47',
        'F': '#0070C0',
        'M': '#C00000',
        'T': '#FFC000',
        'P': '#FF6600',
        'O': '#000000'
    };
    return cores[prefixo] || '#888';
}

function fecharModalEditarDia() {
    document.getElementById('modalEditarDia').style.display = 'none';
}

function adicionarAlocacaoNoDia(data) {
    document.getElementById('dataNova').value = data;
    fecharModalEditarDia();
    abrirModalNovaAlocacao();
}

async function deletarAlocacao(id) {
    if (!confirm('Tem certeza que deseja deletar esta alocação?')) return;
    
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`/api/cronogramas/alocacoes/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            alert('Alocação deletada com sucesso!');
            fecharModalEditarDia();
            carregarAlocacoes();
        } else {
            alert('Erro ao deletar alocação');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar alocação');
    }
}

async function exportarPDF() {
    const token = localStorage.getItem('token');
    const dataInicio = getDataInicioMes();
    const dataFim = getDataFimMes();
    const consultorId = document.getElementById('consultorFiltro').value;
    
    let url = `/api/cronogramas/alocacoes/exportar/pdf?data_inicio=${dataInicio}&data_fim=${dataFim}`;
    if (consultorId) url += `&consultor_id=${consultorId}`;
    
    try {
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = 'cronograma.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);
        } else {
            alert('Erro ao exportar PDF');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao exportar PDF');
    }
}

async function exportarExcel() {
    const token = localStorage.getItem('token');
    const dataInicio = getDataInicioMes();
    const dataFim = getDataFimMes();
    const consultorId = document.getElementById('consultorFiltro').value;
    
    let url = `/api/cronogramas/alocacoes/exportar/excel?data_inicio=${dataInicio}&data_fim=${dataFim}`;
    if (consultorId) url += `&consultor_id=${consultorId}`;
    
    try {
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = 'cronograma.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);
        } else {
            alert('Erro ao exportar Excel');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao exportar Excel');
    }
}

function getDataInicioMes() {
    const ano = mesAtual.getFullYear();
    const mes = String(mesAtual.getMonth() + 1).padStart(2, '0');
    return `${ano}-${mes}-01`;
}

function getDataFimMes() {
    const ultimoDia = new Date(mesAtual.getFullYear(), mesAtual.getMonth() + 1, 0).getDate();
    const ano = mesAtual.getFullYear();
    const mes = String(mesAtual.getMonth() + 1).padStart(2, '0');
    return `${ano}-${mes}-${ultimoDia}`;
}

document.addEventListener('DOMContentLoaded', () => {
    const hoje = new Date();
    mesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    
    document.getElementById('mesAno').value = 
        `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
    
    carregarConsultores();
    carregarAlocacoes();
});
</script>
{% endblock %}
